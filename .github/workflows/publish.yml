name: Publish to TestPyPI

on:
  release:
    types: [created]
  workflow_dispatch:  # Allow manual triggering

jobs:
  publish-testpypi:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
      - name: Free up disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          docker system prune -af || true
      
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          cache: 'pip'
      
      - name: Install build tools
        run: |
          python -m pip install --upgrade pip
          pip install build twine
      
      - name: Verify version consistency
        run: |
          # Extract version from pyproject.toml
          VERSION_PYPROJECT=$(grep -E '^version\s*=' pyproject.toml | sed -E 's/.*version\s*=\s*"([^"]+)".*/\1/')
          # Extract version from __init__.py
          VERSION_INIT=$(grep -E '^__version__\s*=' src/dta_gnn/__init__.py | sed -E "s/.*__version__\s*=\s*['\"]([^'\"]+)['\"].*/\1/")
          
          echo "Version in pyproject.toml: $VERSION_PYPROJECT"
          echo "Version in __init__.py: $VERSION_INIT"
          
          if [ "$VERSION_PYPROJECT" != "$VERSION_INIT" ]; then
            echo "‚ùå Version mismatch between pyproject.toml and __init__.py"
            exit 1
          fi
          
          # Check if version matches release tag (if available)
          if [ -n "${{ github.event.release.tag_name }}" ]; then
            TAG_VERSION="${{ github.event.release.tag_name }}"
            # Remove 'v' prefix if present
            TAG_VERSION=${TAG_VERSION#v}
            echo "Release tag version: $TAG_VERSION"
            
            if [ "$VERSION_PYPROJECT" != "$TAG_VERSION" ]; then
              echo "‚ö†Ô∏è  Warning: Version in code ($VERSION_PYPROJECT) doesn't match release tag ($TAG_VERSION)"
              echo "Continuing anyway..."
            fi
          fi
      
      - name: Build package
        run: |
          python -m build
      
      - name: Check package
        run: |
          twine check dist/*
      
      - name: Publish to TestPyPI
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.TESTPYPI_API_TOKEN }}
        run: |
          twine upload --repository testpypi --skip-existing --verbose dist/* || {
            echo "‚ùå Upload failed. Common causes:"
            echo "   1. Filename was previously used and deleted (Test PyPI restriction - bump version)"
            echo "   2. Package already exists (should be skipped with --skip-existing)"
            echo "   3. Invalid metadata in pyproject.toml"
            echo "   4. API token permissions issue"
            echo ""
            echo "Note: Test PyPI doesn't allow reusing filenames from deleted packages."
            echo "      You must increment the version number to upload again."
            echo ""
            echo "Check the verbose output above for details."
            exit 1
          }
      
      - name: Verify publication
        run: |
          echo "‚úÖ Package published to TestPyPI!"
          echo "üì¶ Test installation with:"
          echo "   pip install --index-url https://test.pypi.org/simple/ dta-gnn"
          echo "üîó View at: https://test.pypi.org/project/dta-gnn/"
